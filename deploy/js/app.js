// Generated by CoffeeScript 1.6.3
var Analizer, Application, Audio, Circle, Fader, MathUtils, Mixer8, Sampler, Vec2, Visualizer,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

Vec2 = (function() {
  Vec2.magnitude = function(vector) {
    return Math.sqrt(vector.x * vector.x + vector.y * vector.y);
  };

  Vec2.magnitudeSq = function(vector) {
    return vector.x * vector.x + vector.y * vector.y;
  };

  function Vec2(x, y) {
    this.x = x != null ? x : 0;
    this.y = y != null ? y : 0;
  }

  Vec2.prototype.normalize = function() {
    var len;
    len = Vec2.magnitude(this);
    if (len > 0.00001) {
      this.x = this.x / len;
      this.y = this.y / len;
    } else {
      this.x = 0;
      this.y = 0;
    }
    return this;
  };

  Vec2.prototype.subtract = function(vector) {
    this.x -= vector.x;
    this.y -= vector.y;
    return this;
  };

  Vec2.prototype.add = function(vector) {
    this.x += vector.x;
    this.y += vector.y;
    return this;
  };

  Vec2.prototype.multiply = function(v) {
    if (v instanceof Vec2) {
      this.x *= v.x;
      this.y *= v.y;
    } else {
      this.x *= v;
      this.y *= v;
    }
    return this;
  };

  Vec2.prototype.divide = function(v) {
    if (v instanceof Vec2) {
      this.x /= v.x;
      this.y /= v.y;
    } else {
      this.x /= v;
      this.y /= v;
    }
    return this;
  };

  Vec2.prototype.limit = function(max) {
    var mag;
    mag = Vec2.magnitudeSq(this);
    if (mag > max * max) {
      this.normalize();
      this.multiply(max);
    }
    return this;
  };

  return Vec2;

})();

MathUtils = (function() {
  function MathUtils() {}

  MathUtils.calculateControlPoints = function(points, factor) {
    var controlPoints, cp, cur, endIndex, i, next, prev, startIndex, _i, _ref;
    if (factor == null) {
      factor = 0.5;
    }
    startIndex = 1;
    endIndex = points.length;
    cp = new Array();
    controlPoints = new Array();
    for (i = _i = startIndex, _ref = endIndex + 1; startIndex <= _ref ? _i < _ref : _i > _ref; i = startIndex <= _ref ? ++_i : --_i) {
      prev = i - 1;
      cur = i % endIndex;
      next = (i + 1) % endIndex;
      cp = this.getControlPoints(points[prev], points[cur], points[next], factor);
      controlPoints.push(cp[0]);
      controlPoints.push(cp[1]);
    }
    return controlPoints;
  };

  MathUtils.getControlPoints = function(p1, p2, p3, t) {
    var d1, d2, fa, fb, point1, point2;
    d1 = Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
    d2 = Math.sqrt(Math.pow(p3.x - p2.x, 2) + Math.pow(p3.y - p2.y, 2));
    fa = t * d1 / (d1 + d2);
    fb = t - fa;
    point1 = new Vec2(Math.round(p2.x + fa * (p1.x - p3.x)), Math.round(p2.y + fa * (p1.y - p3.y)));
    point2 = new Vec2(Math.round(p2.x - fb * (p1.x - p3.x)), Math.round(p2.y - fb * (p1.y - p3.y)));
    return [point1, point2];
  };

  return MathUtils;

})();

Circle = (function() {
  Circle.prototype.position = new Vec2();

  Circle.prototype.points = [];

  Circle.factor = 0.5;

  Circle.octaves = 6;

  Circle.debug = false;

  function Circle(context, radius, color) {
    if (radius == null) {
      radius = 150;
    }
    if (color == null) {
      color = '#0FF';
    }
    this.context = context;
    this.radius = radius;
    this.indexes = new Float32Array(20);
    this.color = color;
  }

  Circle.prototype.translate = function(x, y) {
    this.position.x = x;
    this.position.y = y;
    return null;
  };

  Circle.prototype.feed = function(index, value) {
    this.indexes[index] = value;
    return null;
  };

  Circle.prototype.draw = function() {
    var a, b, c, d, i, j, newPoints, _i, _j, _k, _ref, _ref1, _ref2;
    this.getOctavesPosition();
    newPoints = MathUtils.calculateControlPoints(this.points, Circle.factor);
    a = 0;
    b = 0;
    this.context.beginPath();
    this.context.strokeStyle = this.color;
    for (i = _i = 0, _ref = this.points.length; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
      a = i;
      b = (i * 2 + newPoints.length - 1) % newPoints.length;
      c = i * 2;
      d = (i + 1) % this.points.length;
      this.context.moveTo(this.points[a].x, this.points[a].y);
      this.context.bezierCurveTo(newPoints[b].x, newPoints[b].y, newPoints[c].x, newPoints[c].y, this.points[d].x, this.points[d].y);
    }
    this.context.lineWidth = 1;
    this.context.stroke();
    this.context.closePath();
    if (Circle.debug) {
      for (j = _j = 0, _ref1 = newPoints.length; 0 <= _ref1 ? _j < _ref1 : _j > _ref1; j = 0 <= _ref1 ? ++_j : --_j) {
        this.context.beginPath();
        this.context.arc(newPoints[j].x, newPoints[j].y, 1, 0, 2 * Math.PI, false);
        this.context.fillStyle = 'white';
        this.context.fill();
        this.context.closePath();
      }
      for (i = _k = 0, _ref2 = this.points.length; 0 <= _ref2 ? _k < _ref2 : _k > _ref2; i = 0 <= _ref2 ? ++_k : --_k) {
        this.context.beginPath();
        this.context.arc(this.points[i].x, this.points[i].y, 2, 0, 2 * Math.PI, false);
        this.context.strokeStyle = 'white';
        this.context.stroke();
        this.context.closePath();
      }
    }
    return null;
  };

  Circle.prototype.getOctavesPosition = function() {
    var angle, i, x, y, _i, _ref;
    this.points = [];
    for (i = _i = 0, _ref = Circle.octaves; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
      angle = i * Math.PI * 2 / Circle.octaves;
      x = this.position.x + Math.cos(angle) * (this.radius + this.indexes[i]);
      y = this.position.y + Math.sin(angle) * (this.radius + this.indexes[i]);
      this.points.push(new Vec2(x, y));
    }
    return null;
  };

  return Circle;

})();

Analizer = (function() {
  function Analizer(input, fftSize) {
    if (fftSize == null) {
      fftSize = 2048;
    }
    this.input = input;
    this.fftSize = fftSize;
    this.output = this.input.context.createAnalyser();
    this.output.fftSize = this.fftSize;
    this.input.connect(this.output);
  }

  Analizer.prototype.analyze = function() {
    var freqByteData;
    freqByteData = new Uint8Array(this.output.frequencyBinCount);
    this.output.getByteFrequencyData(freqByteData);
    return freqByteData;
  };

  Analizer.prototype.average = function() {
    var data, i, total, values, _i;
    data = this.analyze();
    values = 0;
    total = data.length;
    for (i = _i = 0; 0 <= total ? _i < total : _i > total; i = 0 <= total ? ++_i : --_i) {
      values += data[i];
    }
    return values / total;
  };

  Analizer.prototype.octaves = function(count) {
    var data, i, octaves, _i;
    data = this.analyze();
    octaves = [];
    for (i = _i = 0; 0 <= count ? _i < count : _i > count; i = 0 <= count ? ++_i : --_i) {
      octaves.push(data[i] / 2);
    }
    return octaves;
  };

  return Analizer;

})();

Visualizer = (function() {
  Visualizer.WAIT = 'fa-spinner fa-spin';

  Visualizer.STOP = 'fa-stop';

  Visualizer.PLAY = 'fa-play';

  Visualizer.prototype.playing = false;

  Visualizer.prototype.circles = [];

  Visualizer.prototype.analyzers = [];

  Visualizer.prototype.precision = 0.11;

  Visualizer.prototype.background = [0, 0, 0];

  function Visualizer(mixer) {
    this.render = __bind(this.render, this);
    this.togglePlayback = __bind(this.togglePlayback, this);
    this.resize = __bind(this.resize, this);
    this.canvas = document.createElement('canvas');
    this.context = this.canvas.getContext('2d');
    document.body.appendChild(this.canvas);
    window.addEventListener('resize', this.resize, false);
    this.mixer = mixer;
    this.init();
  }

  Visualizer.prototype.init = function() {
    var i, _i;
    for (i = _i = 0; _i < 5; i = ++_i) {
      this.circles.push(new Circle(this.context));
      this.analyzers.push(new Analizer(this.mixer.channels[i].input));
    }
    this.handleState(Visualizer.WAIT);
    this.resize();
    this.render();
    return null;
  };

  Visualizer.prototype.resize = function(e) {
    var i, _i, _ref;
    this.width = window.innerWidth;
    this.height = window.innerHeight;
    this.canvas.width = this.width;
    this.canvas.height = this.height;
    for (i = _i = 0, _ref = this.circles.length; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
      this.circles[i].translate(this.width / 2, this.height / 2);
    }
    return null;
  };

  Visualizer.prototype.toggleInfo = function() {
    $('#info').toggleClass('disable');
    if ($('#info').hasClass('disable')) {
      $('#more-info').hide();
    } else {
      $('#more-info').show().css({
        'display': 'table'
      });
    }
    return null;
  };

  Visualizer.prototype.togglePlayback = function(e) {
    this.playing = !this.playing;
    this.handleState(this.playing === true ? Visualizer.PLAY : Visualizer.STOP);
    return null;
  };

  Visualizer.prototype.handleState = function(state) {
    if (state === Visualizer.PLAY) {
      Application.STAGE.playback.dispatch('stop');
    } else if (state === Visualizer.STOP) {
      Application.STAGE.playback.dispatch('play');
    }
    return null;
  };

  Visualizer.prototype.render = function() {
    var alpha, circle, i, j, value, _i, _j, _ref, _ref1;
    alpha = Circle.debug === true ? 1 : this.precision;
    if (alpha === 1) {
      this.context.clearRect(0, 0, this.width, this.height);
    } else {
      this.context.beginPath();
      this.context.fillStyle = 'rgba(' + Math.round(this.background[0]) + ',' + Math.round(this.background[1]) + ',' + Math.round(this.background[2]) + ', ' + alpha + ')';
      this.context.fillRect(0, 0, this.width, this.height);
      this.context.closePath();
    }
    for (i = _i = 0, _ref = this.circles.length; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
      circle = this.circles[i];
      value = this.analyzers[i].octaves(Circle.octaves);
      for (j = _j = 0, _ref1 = Circle.octaves; 0 <= _ref1 ? _j < _ref1 : _j > _ref1; j = 0 <= _ref1 ? ++_j : --_j) {
        circle.feed(j, value[j]);
      }
      circle.draw();
    }
    requestAnimationFrame(this.render);
    return null;
  };

  return Visualizer;

})();

Fader = (function() {
  function Fader(context, output) {
    this.context = context;
    this.volume = 1;
    this.input = this.context.createGain();
    this.output = output;
    this.input.connect(this.output);
  }

  Fader.prototype.changeVolume = function(value) {
    var fraction;
    this.volume = value;
    fraction = value / 1;
    this.input.gain.value = fraction * fraction;
    return null;
  };

  return Fader;

})();

Mixer8 = (function() {
  Mixer8.prototype.channels = [];

  function Mixer8(context) {
    this.context = context;
    this.master = new Fader(this.context, this.context.destination);
    this.channels[0] = new Fader(this.context, this.master.input);
    this.channels[1] = new Fader(this.context, this.master.input);
    this.channels[2] = new Fader(this.context, this.master.input);
    this.channels[3] = new Fader(this.context, this.master.input);
    this.channels[4] = new Fader(this.context, this.master.input);
    this.channels[5] = new Fader(this.context, this.master.input);
    this.channels[6] = new Fader(this.context, this.master.input);
    this.channels[7] = new Fader(this.context, this.master.input);
  }

  return Mixer8;

})();

Sampler = (function() {
  function Sampler(context) {
    this.context = context;
    this.memory = {
      files: [],
      buffers: [],
      sources: []
    };
    this.signals = {};
    this.signals.progress = new signals.Signal();
    this.signals.complete = new signals.Signal();
  }

  Sampler.prototype.add = function(url) {
    this.memory.files.push(url);
    return null;
  };

  Sampler.prototype.load = function() {
    var i, _i, _ref, _results;
    _results = [];
    for (i = _i = 0, _ref = this.memory.files.length; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
      _results.push(this.loadBuffer(this.memory.files[i]));
    }
    return _results;
  };

  Sampler.prototype.loadBuffer = function(url) {
    var request,
      _this = this;
    request = new XMLHttpRequest();
    request.open("GET", url, true);
    request.responseType = "arraybuffer";
    request.onload = function() {
      _this.context.decodeAudioData(request.response, function(buffer) {
        if (!buffer) {
          console.error('error decoding audio buffer for', url);
          return;
        }
        _this.memory.buffers[url] = buffer;
        _this.signals.progress.dispatch('progress', {
          'progress': Object.keys(_this.memory.buffers).length,
          'total': _this.memory.files.length
        });
        if (Object.keys(_this.memory.buffers).length === _this.memory.files.length) {
          _this.signals.complete.dispatch('complete', {});
        }
        return null;
      }, function(error) {
        console.error('decode error', error);
      });
      return null;
    };
    request.send();
    return null;
  };

  return Sampler;

})();

Audio = (function() {
  Audio.prototype.isPlaying = false;

  Audio.prototype.sources = [];

  function Audio() {
    this.onSamplerComplete = __bind(this.onSamplerComplete, this);
    this.onSamplerProgress = __bind(this.onSamplerProgress, this);
    this.context = new webkitAudioContext();
    this.mixer = new Mixer8(this.context);
    this.info = document.getElementById('info');
    this.sampler = new Sampler(this.context);
    this.sampler.signals.progress.add(this.onSamplerProgress);
    this.sampler.signals.complete.add(this.onSamplerComplete);
    this.sampler.add('mp3/radiohead/Nude (Drum Stem).mp3');
    this.sampler.add('mp3/radiohead/Nude (Bass Stem).mp3');
    this.sampler.add('mp3/radiohead/Nude (Guitar Stem).mp3');
    this.sampler.add('mp3/radiohead/Nude (String FX Stem).mp3');
    this.sampler.add('mp3/radiohead/Nude (Voice Stem).mp3');
    this.sampler.load();
  }

  Audio.prototype.onSamplerProgress = function(type, params) {
    this.info.innerHTML = 'Loading sound ' + params.progress + ' of ' + params.total;
    return null;
  };

  Audio.prototype.onSamplerComplete = function(type, params) {
    this.info.innerHTML = '"Nude" is a song by the English rock band <strong>Radiohead</strong>, appearing as the third track on their 2007 album In Rainbows.<br/><br/>Visualization inspired by the Nike Moves App.';
    Application.STAGE.playback.dispatch('ready');
    return null;
  };

  Audio.prototype.playAll = function() {
    var i, input, instrument, _i, _ref;
    if (this.isPlaying === true) {
      return;
    }
    this.isPlaying = true;
    for (i = _i = 0, _ref = this.sampler.memory.files.length; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
      instrument = this.sampler.memory.buffers[this.sampler.memory.files[i]];
      input = this.mixer.channels[i].input;
      this.playSound(instrument, input);
    }
    return null;
  };

  Audio.prototype.stopAll = function() {
    var i, source, _i, _ref;
    if (this.isPlaying === false) {
      return;
    }
    this.isPlaying = false;
    for (i = _i = 0, _ref = this.sources.length; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
      source = this.sources[i];
      if (!source.stop) {
        source.stop = source.noteOff;
      }
      source.stop(0);
    }
    this.sources = [];
    return null;
  };

  Audio.prototype.playSound = function(buffer, input, time_, loop_) {
    var source;
    if (time_ == null) {
      time_ = 0;
    }
    if (loop_ == null) {
      loop_ = false;
    }
    source = this.context.createBufferSource();
    source.buffer = buffer;
    source.connect(input);
    source.loop = loop_;
    if (!source.start) {
      source.start = source.noteOn;
    }
    source.start(time_);
    this.sources.push(source);
    return null;
  };

  return Audio;

})();

Application = (function() {
  Application.STAGE = {};

  function Application() {
    this.onPlayback = __bind(this.onPlayback, this);
    var bass, color, drums, folder, fx, gtr, i, voice, _i,
      _this = this;
    this.settings = {
      info: true,
      debug: false,
      drums: {
        color: '#ff0000',
        volume: 1
      },
      bass: {
        color: '#6d89e3',
        volume: 1
      },
      guitar: {
        color: '#a2e368',
        volume: 1
      },
      effects: {
        color: '#00afa3',
        volume: 1
      },
      voice: {
        color: '#ffffff',
        volume: 1
      }
    };
    Application.STAGE.playback = new signals.Signal();
    Application.STAGE.playback.add(this.onPlayback);
    this.audio = new Audio();
    this.visualizer = new Visualizer(this.audio.mixer, this.settings.colors);
    this.gui = new dat.GUI();
    this.gui.add(this.settings, 'info').onChange(function(value) {
      return _this.visualizer.toggleInfo();
    });
    this.gui.add(this.settings, 'debug').onChange(function(value) {
      return Circle.debug = value;
    });
    this.gui.add(Circle, 'factor', -1, 1);
    this.gui.add(Circle, 'octaves', 3, 20).step(1);
    this.gui.add(this.visualizer, 'precision', 0, 1).step(0.01).name('blur');
    this.gui.addColor(this.visualizer, 'background');
    folder = this.gui.addFolder('Instruments');
    drums = folder.addFolder('Drums');
    drums.addColor(this.settings.drums, 'color').onChange(function(value) {
      return _this.changeColor(0, value);
    });
    drums.add(this.settings.drums, 'volume', 0, 1).onChange(function(value) {
      return _this.audio.mixer.channels[0].changeVolume(value);
    });
    bass = folder.addFolder('Bass');
    bass.addColor(this.settings.bass, 'color').onChange(function(value) {
      return _this.changeColor(1, value);
    });
    bass.add(this.settings.bass, 'volume', 0, 1).onChange(function(value) {
      return _this.audio.mixer.channels[1].changeVolume(value);
    });
    gtr = folder.addFolder('Guitar');
    gtr.addColor(this.settings.guitar, 'color').onChange(function(value) {
      return _this.changeColor(2, value);
    });
    gtr.add(this.settings.guitar, 'volume', 0, 1).onChange(function(value) {
      return _this.audio.mixer.channels[2].changeVolume(value);
    });
    fx = folder.addFolder('Effects');
    fx.addColor(this.settings.effects, 'color').onChange(function(value) {
      return _this.changeColor(3, value);
    });
    fx.add(this.settings.effects, 'volume', 0, 1).onChange(function(value) {
      return _this.audio.mixer.channels[3].changeVolume(value);
    });
    voice = folder.addFolder('Voice');
    voice.addColor(this.settings.voice, 'color').onChange(function(value) {
      return _this.changeColor(4, value);
    });
    voice.add(this.settings.voice, 'volume', 0, 1).onChange(function(value) {
      return _this.audio.mixer.channels[4].changeVolume(value);
    });
    for (i = _i = 0; _i < 5; i = ++_i) {
      color = this.transformIndexIntoColor(i);
      this.changeColor(i, color);
    }
  }

  Application.prototype.changeColor = function(index, color) {
    this.visualizer.circles[index].color = color;
    return null;
  };

  Application.prototype.transformIndexIntoColor = function(index) {
    var color;
    color = '';
    switch (index) {
      case 0:
        color = this.settings.drums.color;
        break;
      case 1:
        color = this.settings.bass.color;
        break;
      case 2:
        color = this.settings.guitar.color;
        break;
      case 3:
        color = this.settings.effects.color;
        break;
      case 4:
        color = this.settings.voice.color;
    }
    return color;
  };

  Application.prototype.onPlayback = function(value) {
    switch (value) {
      case 'ready':
        this.visualizer.handleState(Visualizer.STOP);
        this.gui.add(this.audio, 'playAll').name('Play');
        this.gui.add(this.audio, 'stopAll').name('Stop');
        break;
      case 'play':
        this.audio.playAll();
        break;
      case 'stop':
        this.audio.stopAll();
    }
    return null;
  };

  return Application;

})();
